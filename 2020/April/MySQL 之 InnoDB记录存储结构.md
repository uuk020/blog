## MySQL 之 InnoDB记录存储结构
MySQL 的 InnoDB 将数据划分为若干个页，以页作为磁盘和内存之间交互的基本单位，InnoDB中页的大小一般为 16 KB

InnoDB 行格式有四种，有Compact、Redundant、Dynamic和Compressed
   ```mysql
   CREATE TABLE 表名 (列的信息) ROW_FORMAT=行格式名称
    
   ALTER TABLE 表名 ROW_FORMAT=行格式名称
   ```

**Compact 行格式**

[![JRpwLQ.jpg](https://s1.ax1x.com/2020/04/26/JRpwLQ.jpg)](https://imgchr.com/i/JRpwLQ)

**变长字段长度列表**

MySQL支持一些变长的数据类型，比如VARCHAR(M)、VARBINARY(M)、各种TEXT类型，各种BLOB类型，我们也可以把拥有这些数据类型的列称为变长字段。

这些变长字段占用的存储空间有2个部分，一个是真正的数据内容，一个是占用字节数。在Compact行格式中，把这些变长字段占用字节数放在记录的开头部分，这些变长字段字节数按行的**倒序**存放的。

如果列中内容占用字节数比较多，可能需要2个字节来表示。具体是用1个还是2个字节来表示真实数据占用字节数。

假设某个字符集中表示一个字符最多需要使用的字节数为W，也就是使用SHOW CHARSET语句的结果中的Maxlen列，对于变长类型VARCHAR(M)来说，这种类型表示能存储最多M个字符（注意是字符不是字节），所以这个类型能表示的字符串最多占用的字节数就是M×W， 假设它实际存储的字符串占用的字节数是L
如果该可变字段允许存储的最大字节数（M×W）超过255字节并且真实存储的字节数（L）超过127字节，则使用2个字节，否则使用1个字节。

变长字段长度列表中只存储值为 非NULL 的列内容占用的长度，值为 NULL 的列的长度是不储存的

对于 CHAR(M) 类型的列来说，当列采用的是定长字符集时，该列占用的字节数不会被加到变长字段长度列表，而如果采用变长字符集时，该列占用的字节数也会被加到变长字段长度列表.

变长字符集的CHAR(M)类型的列要求至少占用M个字节，而VARCHAR(M)却没有这个要求。比方说对于使用utf8字符集的CHAR(10)的列来说，该列存储的数据字节长度的范围是10～30个字节。即使我们向该列中存储一个空字符串也会占用10个字节，这是怕将来更新该列的值的字节长度大于原有值的字节长度而小于10个字节时，可以在该记录处直接更新，而不是在存储空间中重新分配一个新的记录空间，导致原有的记录空间成为所谓的碎片。

**Null值列表**

Compact行格式把这些值为NULL的列统一管理起来，存储到NULL值列表中。
1. 先统计表中允许存NULL的列有哪些
2. 如果表中没有允许存储NULL的列，则NULL值列表不存在，否则将每个允许存储NULL的列对应一个二进制位，二进制位按照列的顺序逆序排列，二进制位表示的意义如下：
   - 二进制位的值为1时，代表该列的值为NULL。
   - 二进制位的值为0时，代表该列的值不为NULL。
3. MySQL规定NULL值列表必须用整数个字节的位表示，如果使用的二进制位个数不是整数个字节，则在字节的高位补0。 

**记录头信息**

它是由固定的5个字节组成。5个字节也就是40个二进制位，不同的位代表不同的意思
![JRmBex.jpg](https://s1.ax1x.com/2020/04/26/JRmBex.jpg)

**记录真实数据**

MySQL会为每个记录默认的添加一些列（也称为隐藏列）, 分别是DB_ROW_ID(行ID， 唯一标识一条记录)、DB_TRX_ID(事务ID， 6字节)和DB_ROLL_PTR(回滚指针， 7字节)

InnoDB表对主键的生成策略：优先使用用户自定义主键作为主键，如果用户没有定义主键，则选取一个Unique键作为主键，如果表中连Unique键都没有定义的话，则InnoDB会为表默认添加一个名为row_id的隐藏列作为主键。

VARCHAR(M)类型的列最多可以占用65535个字节。其中的M代表该类型最多存储的字符数量。但VARCHAR(65535)却会报错，即使表中只有这一个varchar字段. 因为存储一个VARCHAR(M)类型的列，需要占用3个部分存储空间：
- 真实数据
- 真实数据占用字节的长度
- NULL值标识，如果该列有NOT NULL属性则可以没有这部分存储空间

如果该VARCHAR类型的列没有NOT NULL属性，那最多只能存储65532个字节的数据，因为真实数据的长度可能占用2个字节，NULL值标识需要占用1个字节

在Compact和Redundant行格式中，对于占用存储空间非常大的列，在记录的真实数据处只会存储该列的一部分数据，把剩余的数据分散存储在几个其他的页中，然后记录的真实数据处用20个字节存储指向这些页的地址（当然这20个字节中还包括这些分散在其他页面中的数据的占用的字节数），从而可以找到剩余数据所在的页。

对于Compact和Redundant行格式来说，如果某一列中的数据非常多的话，在本记录的真实数据处只会存储该列的前768个字节的数据和一个指向其他页的地址，然后把剩下的数据存放到其他页中，这个过程也叫做行溢出，存储超出768字节的那些页面也被称为溢出页。

Redundant行格式是MySQL5.0之前用的一种行格式。

Dynamic和Compressed行格式，这俩行格式和Compact行格式挺像，只不过在处理行溢出数据时有点儿分歧，它们不会在记录的真实数据处存储字段真实数据的前768个字节，而是把所有的字节都存储到其他页面中，只在记录的真实数据处存储其他页面的地址。

Compressed行格式和Dynamic不同的一点是，Compressed行格式会采用压缩算法对页面进行压缩，以节省空间。